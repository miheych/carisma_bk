Необходимые инструменты и компоненты:
-----------------------------------

Для реализации проекта понадобятся следующие инструменты:
1. Цифровой мультиметр(не обязательно, но может пригодиться);
2. Блок питания на 12В. (если соберетесь сначала проверить схему на столе, а не на машине)
3. Паяльник и принадлежности.

И компоненты:
1. Плата [arduino nano](http://arduino.ru/Hardware/ArduinoBoardNano) или ее аналоги. В настоящее время есть версии ардуино с разными преобразователями USB-COM борту, в зависимости от преобразователя будут устанавливаться разные драйверы. Лучший вариант конечно, если у вас будет плата ардуино c преобразователем на чипе FT232RL, так как работа таких плат проверена на практике.
2. Набор тонких проводов(лучше разных цветов) для подключения платы к БК  - можно приобрести в любом магазине радиотоваров, или использовать например старый шлейф от жесткого диска.
3. Микросхема-драйвер K-линии MC33290 (альтернативный вариант - L9637D) - 1 шт.
4. Резистор на 4,7 кОм - 3 шт.
5. Резистор на 10 кОм - 2 шт.
6. Подстроечный резистор на 33 кОм - 1 шт.
7. Резистор на 510 Ом - 1 шт.
8. Цифровой датчик температуры DS18B20 - 1 шт.
9. Тактовая кнопка.
10. Фольгированный текстолит для изготовления печатной платы, ну и компоненты для этого. О том как травить платы есть масса статей в интернете.

Процесс доработки:
-----------------------------------

Снимаем БК с автомобиля и приносим его домой. На задней стенке имеются 2 разъема, обозначенные на электросхемах как B108 и B109:

![](https://github.com/miheych/carisma_bk/blob/master/Pict/%D0%A0%D0%B0%D0%B7%D1%8A%D0%B5%D0%BC%D1%8B%20B108%20B109.jpg)

Вот нумерация их контактов с описанием тех, которые могут пригодится:

**B109:**

5. к диагностическому разъему;
15. к диагностическому пину ECU.

**B108:**

23. уличный термо-сенсор;
31. уличный термо-сенсор;
25. ACC
26. "+" появляется при включении зажигания;
27. сигнал с датчика скорости;
28. земля;
32. подсветка;
33. сигнал с датчика уровня топлива.


Сняв БК, нужно убедится, что он работает автономно, подав на него 12В от блока питания на 25 и 28 контакты разъема B108. На дисплее должны отобразиться буквы EE вместо температуры(так как не подсоединен датчик) и часы.

После этого аккуратно разбираем блок БК. Электронная его часть состоит из двух плат: процессорной платы и платы контроллера дисплея. Маркировку процессора определить не удалось, однако с контроллера дисплея ее считать получилось: он выполнен на микросхеме [OKI6775T](https://github.com/miheych/carisma_bk/blob/master/Docs/MSM6775.pdf).

Согласно информации из даташита следует, что данные загружаются в дисплей с процессора c помощью трех шин: DATA(данные), LOAD(сигнал загрузки блока) и CLOCK (тактирование). Дисплейная и процессорная платы соединены между собой двумя шлейфами из 6 проводов. Нас интересует тот что ближе к центру платы, а в нем 3 провода, показанные на схеме ниже. Данные по этим проводам передаются по протоколу похожему на SPI, который аппаратно поддерживают многие микроконтроллеры. 

Таким образом, если разорвать эти 3 провода и вставить в разрыв микроконтроллер, можно принимать данные с процессорной платы, добавлять к ним информацию для вывода в нижнюю строку, и отправлять их на контроллер дисплея.

Вот итоговая схема, работоспособность которой проверена нескольких автомобилях:

![](https://github.com/miheych/carisma_bk/blob/master/Connection%20schemes/rev3_with_mc33290.jpg)

*Резистор R2 не обязателен, но дорожку под него лучше развести на плате. Возможно, потребуется впаять его, если не будут корректно отображаться температура наружнего воздуха и часы.

Вариант схемы при использовании в качестве драйвера К-линии микросхемы L9637D можно посмотреть [здесь](https://github.com/miheych/carisma_bk/blob/master/Connection%20schemes/rev3_with_L9637D.jpg).

Печатную плату несложно самостоятельно развести и изготовить под свои потребности методом "ЛУТ", либо воспользоваться одним из вариантов, предложенных пользователями на форуме [carisma-club](http://carisma-club.su/index.php?showtopic=2685).

По поводу подстроечного резистора R3: он требуется для подстройки показаний бортового напряжения под реальные значения. Для этого после сборки и проверки на работоспособность всей системы включаем ключем режим ACC, а БК - в режим 2 отображения бортового напряжения. После этого берем обычный тестер и измеряем бортовое напряжение, а подстроечным резистором подгоняем показания на БК под уровень реального напряжения. Важно всё это делать именно в режиме ACC, так как когда включено зажигание или заведен двигатель, показания бортового напряжения считываются с "мозгов" автомобиля.

Тем кто будет трассировать печатную плату самостоятельно рекомендую сделать возможность подключения к любому из свободных пинов платы ардуино, этим вы оставите возможность что-либо доподключить к плате без ее переделки. Вполне возможно, что в будущем на эти выводы добавиться еще какой-нибудь полезный функционал.

Краткая инструкция по прошивке платы ардуино.
-------------
Для тех, кто не собирается вносить какие-либо изменения в исходный код прошивки, не обязательно устанавливать среду программиования Arduino IDE. Можно воспользоваться упрощенным вариантом загрузки готового .hex файла на плату:

1. Подключаем плату arduino в USB порт. Windows обычно устанавливает драйвера автоматически. 
2. Запускаем "диспетчер устройств", смотрим какой COM порт назначился для arduino:
![](https://github.com/miheych/carisma_bk/blob/master/Pict/%D0%94%D0%B8%D1%81%D0%BF%D0%B5%D1%82%D1%87%D0%B5%D1%80%20%D1%83%D1%81%D1%82%D1%80%D0%BE%D0%B9%D1%81%D1%82%D0%B2.jpg)
3. Убеждаемся, что к контактам arduino D0 и D1 ничего не подключено, запускаем программу для загрузки .hex файла на плату (например, XLoader).
4. Выбираем COM порт который видели в диспетчере устройств, тип платы Nano(ATmega328), указываем путь к .hex файлу прошивки и нажимаем кнопку Upload:
5. После нескольких секунд загрузки программа выведет количество загруженных байт.
Все. На этом процесс прошивки платы можно считать завершенным.

При окончательной сборке лучше вывести куда-нибудь в доступное место USB кабель от ардуино, чтобы впоследствии можно было обновлять прошивку. Прошивку установленной в автомобиль платы следует проводить при выключенном зажигании и ACC, чтобы избежать подачи питания с двух сторон (от БК и с USB).

После загрузки прошивки и сборки схемы, лучше всего провести тестовый запуск на столе, запитав БК от источника 12В. Если все прошло хорошо - у вас должна отобразиться нижняя строчка, часы, кнопкой должны переключаться режимы. В случае если часы не отображаются, нужно попробовать запаять резистор R2. Если и после этого часы не появились - это знак, что что-то пошло не так и стоит еще раз все перепроверить.

Если тестирование прошло успешно, то можно устанавливать собранную плату в подходящий корпус(можно подобрать в магазинах радиодеталей, подключать к автомобилю и проверять схему в "боевом" режиме.
